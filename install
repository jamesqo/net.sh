#!/usr/bin/env bash

get_path()
{
    powershell "[Environment]::GetEnvironmentVariable('PATH', 'User')"
}

set_path()
{
    powershell "[Environment]::SetEnvironmentVariable('PATH', '$1', 'User')"
}

wpwd()
{
    powershell 'Write-Host -NoNewline $pwd'
}

targetdir=~/AppData/Local/sh.net

# Cleanup from previous installs
rm -rf "$targetdir"
mkdir -p "$targetdir"

for script in scripts/*
do
    name=$(basename "$script")
    dest="$targetdir/$name"
    
    # Do the work
    cat "$script" | tee "$dest" 1> /dev/null # use tee to handle null chars
    chmod a+rx "$dest" # modify permissions
    
    # Add to $PATH
    if ! type "$name" &>/dev/null; then
        current_path=$(get_path)
        to_append=$(cd "$targetdir" && wpwd)
        set_path "$current_path;$to_append"
    fi
done
